#!/usr/bin/env python3
"""
Usage: gci-validator (FILE)

--version   Show program version

"""
from docopt import docopt
import csv
import os
import sys

BOOLEAN_VALUES = ['yes', 'no']
VALID_CATEGORIES = ['1', '2', '3', '4', '5']
REQUIRED_FIELDS = [
    "name", "description", "mentors", "categories", "time_to_complete_in_days"
]
FIELD_VALIDATORS = {
    "name": [lambda x: len(x) <= 200, "'name' must be less than or equal to 200 characters"],
    "description": [lambda x: len(x) <= 500, "'description' must be less than or equal to 500 characters"],
    "status": [lambda x: x == "1" or x == "2", "valid 'status' values: [1, 2]"],
    "max_instances": [lambda x: int(x) > 0 and int(x) <= 100, "'max_instances' must be between 0 and 100"],
    "mentors": [lambda x: len(x.split(",")) <= 30, "'mentors' can contain at most 30 comma-separated list of emails"],
    "is_beginner": [lambda x: x in BOOLEAN_VALUES, "valid 'is_beginner' values: {0}".format(BOOLEAN_VALUES)],
    "tags": [lambda x: True, ""],
    "categories": [lambda x: len([item for item in x.split(',') if item not in VALID_CATEGORIES]) == 0, "'categories' must be a comma-separated list of the following category IDs: {0}".format(VALID_CATEGORIES)],
    "time_to_complete_in_days": [lambda x: int(x) >= 3 and int(x) <= 7, "'time_to_complete_in_days' must be between 3 and 7"],
    "private_metadata": [lambda x: len(str(x)) <= 80, "'private_metadata' can contain a maximum of 80 characters"],
    "external_url": [lambda x: True, ""]
}


def not_valid_categories(input):
    return not str(input) in ["1", "2", "3", "4", "5"]


def get_missing_fields(fields):
    return list(set(REQUIRED_FIELDS) - set(fields) & set(REQUIRED_FIELDS))


def validate_row(index, row):
    for field, value in row.items():
        if not value:
            if field in REQUIRED_FIELDS:
                print("{0} - Required field left blank: {1}".format(
                    index, field))
            continue
        elif not FIELD_VALIDATORS[field][0](value):
            print("{0} - Invalid field '{1}' with value {2}. {3}".format(
                index, field, value, FIELD_VALIDATORS[field][1]))


if __name__ == '__main__':
    arguments = docopt(__doc__, version="0.0.1")
    file_name = arguments["FILE"]
    if os.path.exists(file_name):
        with open(file_name, mode="r") as file:
            try:
                reader = csv.DictReader(file, )
                missing_fields = get_missing_fields(reader.fieldnames)
                if len(missing_fields) > 0:
                    print("The following fields are required: {0}".format(
                        missing_fields))
                    sys.exit(0)
                for index, row in enumerate(reader):
                    validate_row(index + 1, row)
                print("Finished")
            except TypeError as err:
                print(err)
    else:
        print("File '{0}' not found".format(file_name))
